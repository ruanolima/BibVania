<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>√ÅREA DO BIBLIOTEC√ÅRIO - BibVania</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="192x192" href="favicon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="stylesheet" href="style.css">
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .school-header-edit {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .edit-school-btn {
            background: var(--primary);
            border: none;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow-y: auto;
        }

        .modal-content {
            background: var(--card);
            width: 100%;
            max-width: 500px;
            border-radius: var(--radius);
            padding: 1.5rem;
            max-height: 90vh;
            overflow-y: auto;
        }

        .loan-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .btn-small {
            padding: 0.4rem 0.6rem;
            font-size: 0.7rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="accessibility-bar">
        <button class="control-btn repository-btn" onclick="window.open('https://github.com/ruanolima/BibVania', '_blank')" style="margin-right: auto;">REPOSIT√ìRIO</button>
        <button class="control-btn" onclick="changeFontSize(1)">A+</button>
        <button class="control-btn" onclick="changeFontSize(-1)">A-</button>
        <button class="control-btn" onclick="toggleReadAloud()" id="readAloudBtn">üîä</button>
        <button class="control-btn" onclick="toggleDarkMode()" id="darkModeBtn">üåô</button>
    </div>

    <header>
        <h1>üìö √ÅREA DO BIBLIOTEC√ÅRIO</h1>
        <div class="school-header-edit">
            <div class="school-name" id="nomeEscolaAdmin" style="text-align: center; width: 100%;">BIBLIOTECA ESCOLAR DA EMTI PROFESSORA MARIA V√ÇNIA FARIAS LINHARES</div>
        </div>
    </header>

    <div class="container">
        <nav style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
            <button onclick="window.location.href='index.html'" class="btn-outline" style="min-width: auto;"><span>üë•</span> LEITORES</button>
            <button onclick="window.location.href='relatorios.html'" class="btn-outline" style="min-width: auto;"><span>üìä</span> RELAT√ìRIOS</button>
            <button onclick="window.DB.signOut()" class="btn-danger" style="grid-column: span 2; min-width: auto;">SAIR DO SISTEMA</button>
        </nav>

        <div class="tabs-container">
            <button class="tab-btn active" onclick="switchTab(event, 'tab-cadastro')">CADASTRO</button>
            <button class="tab-btn" onclick="switchTab(event, 'tab-emprestimo')">EMPR√âSTIMO</button>
            <button class="tab-btn" onclick="switchTab(event, 'tab-registro')">ACERVO</button>
        </div>

        <!-- TAB: CADASTRO -->
        <div id="tab-cadastro" class="tab-content active">
            <div class="card">
                <h2><span>‚ûï</span> NOVO LIVRO</h2>
                <form id="formLivro">
                    <div class="form-group"><label>ISBN (OPCIONAL)</label><input type="text" id="isbn"></div>
                    <div class="form-group"><label>T√çTULO DO LIVRO *</label><input type="text" id="titulo" required></div>
                    <div class="form-group"><label>AUTOR (OPCIONAL)</label><input type="text" id="autor"></div>
                    <div class="form-group"><label>CATEGORIA *</label><select id="categoria" required></select></div>
                    <div class="form-group"><label>QUANTIDADE TOTAL *</label><input type="number" id="quantidade" min="1" required></div>
                    <div class="form-group full-width"><label>SINOPSE (OPCIONAL)</label><textarea id="sinopse" rows="3"></textarea></div>
                    <button type="submit" class="btn-block btn-primary">CADASTRAR LIVRO</button>
                </form>
                <div id="msgLivro" style="margin-top:1rem; text-align:center; font-weight:bold; font-size:0.8rem;"></div>
            </div>
        </div>

        <!-- TAB: EMPR√âSTIMO -->
        <div id="tab-emprestimo" class="tab-content">
            <div class="card">
                <h2><span>üìñ</span> REGISTRAR SA√çDA</h2>
                <form id="formEmprestimo">
                    <div class="form-group full-width">
                        <label class="checkbox-container" id="labelProfessor">
                            <input type="checkbox" id="ehProfessor" onchange="toggleTipoPessoa()">
                            PROFESSOR / FUNCION√ÅRIO
                        </label>
                    </div>
                    <div class="form-group full-width" style="position: relative;">
                        <label>BUSCAR LIVRO *</label>
                        <input type="text" id="livroSearch" placeholder="DIGITE O T√çTULO OU ID..." required>
                        <input type="hidden" id="livroId">
                        <div id="sugestoes" class="card" style="display:none; position:absolute; top:100%; left:0; right:0; z-index:100; padding:0.5rem; max-height:200px; overflow-y:auto;"></div>
                    </div>
                    
                    <div id="camposAluno" style="display:contents;">
                        <div class="form-group"><label>NOME DO ALUNO *</label><input type="text" id="nomeAluno"></div>
                        <div class="form-group">
                            <label>SEXO *</label>
                            <select id="sexo">
                                <option value="">SELECIONE</option>
                                <option value="M">ALUNO</option>
                                <option value="F">ALUNA</option>
                            </select>
                        </div>
                        <div class="form-group"><label>ANO *</label><input type="number" id="ano" min="1" max="9"></div>
                        <div class="form-group"><label>TURMA *</label><input type="text" id="turma"></div>
                    </div>

                <div id="camposProfessor" style="display:none;">
                    <div class="form-group"><label>NOME DO PROFESSOR/FUNCION√ÅRIO *</label><input type="text" id="nomeProfessor"></div>
                    <div class="form-group">
                        <label>SEXO *</label>
                        <select id="sexoProfessor">
                            <option value="">SELECIONE</option>
                            <option value="M">FUNCION√ÅRIO</option>
                            <option value="F">FUNCION√ÅRIA</option>
                        </select>
                    </div>
                </div>

                    <div class="form-group">
                        <label>DIAS DE EMPR√âSTIMO *</label>
                        <input type="number" id="dias" min="1" value="7">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-container" id="labelSemData" style="margin-top:1.5rem;">
                            <input type="checkbox" id="semData" onchange="toggleData()">
                            SEM DATA DEFINIDA
                        </label>
                    </div>
                    <button type="submit" class="btn-block btn-success">CONFIRMAR EMPR√âSTIMO</button>
                </form>
                <div id="msgEmp" style="margin-top:1rem; text-align:center; font-weight:bold; font-size:0.8rem;"></div>
            </div>
        </div>

        <!-- TAB: ACERVO -->
        <div id="tab-registro" class="tab-content">
            <div class="card">
                <div class="form-group">
                    <label>FILTRAR ACERVO</label>
                    <input type="text" id="buscaAdmin" placeholder="BUSCAR LIVRO...">
                </div>
                <div id="admin-cats" class="category-tabs"></div>
            </div>

            <div id="secaoAtrasadosAdmin" class="atrasados-section hidden">
                <h2 style="color:var(--danger); border:none; margin-bottom:0.5rem;">‚ö†Ô∏è ATRASADOS</h2>
                <div id="listaAtrasadosAdmin"></div>
            </div>

            <div id="listaAdmin"></div>
        </div>
    </div>

    <!-- MODAL EDI√á√ÉO LIVRO -->
    <div id="modalEdit" class="modal hidden">
        <div class="modal-content">
            <h2 style="border:none;">EDITAR LIVRO</h2>
            <form id="formEdit">
                <input type="hidden" id="editId">
                <div class="form-group"><label>ISBN</label><input type="text" id="editIsbn"></div>
                <div class="form-group"><label>T√çTULO *</label><input type="text" id="editTitulo" required></div>
                <div class="form-group"><label>AUTOR</label><input type="text" id="editAutor"></div>
                <div class="form-group"><label>CATEGORIA *</label><select id="editCategoria" required></select></div>
                <div class="form-group"><label>QUANTIDADE TOTAL *</label><input type="number" id="editQtd" required></div>
                <div class="form-group"><label>SINOPSE</label><textarea id="editSinopse" rows="3"></textarea></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem;">
                    <button type="button" onclick="closeModal()" class="btn-block btn-outline">CANCELAR</button>
                    <button type="submit" class="btn-block btn-primary">SALVAR</button>
                </div>
            </form>
        </div>
    </div>

    <!-- VLibras Widget -->
    <div vw class="enabled">
        <div vw-access-button class="active"></div>
        <div vw-plugin-wrapper>
            <div class="vw-plugin-top-wrapper"></div>
        </div>
    </div>
    <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
    <script>
        new window.VLibras.Widget('https://vlibras.gov.br/app');
    </script>

    <script src="database.js" type="module"></script>
    <script type="module">
        import DB from './database.js';
        window.DB = DB;
        let currentCat = 'TODOS';
        let todosLivros = [];
        let fontSize = parseInt(localStorage.getItem('fontSize')) || 16;
        let isReading = false;
        const synth = window.speechSynthesis;

        window.changeFontSize = (delta) => {
            fontSize = Math.min(Math.max(fontSize + delta, 12), 24);
            document.documentElement.style.setProperty('--font-size', fontSize + 'px');
            localStorage.setItem('fontSize', fontSize);
        };

        window.toggleDarkMode = () => {
            const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('darkModeBtn').innerText = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', theme);
        };

        window.toggleReadAloud = () => {
            if (isReading) {
                synth.cancel();
                isReading = false;
                document.getElementById('readAloudBtn').innerText = 'üîä';
            } else {
                const textToRead = document.body.innerText;
                const utterance = new SpeechSynthesisUtterance(textToRead);
                utterance.lang = 'pt-BR';
                utterance.onend = () => {
                    isReading = false;
                    document.getElementById('readAloudBtn').innerText = 'üîä';
                };
                synth.speak(utterance);
                isReading = true;
                document.getElementById('readAloudBtn').innerText = '‚èπÔ∏è';
            }
        };

        function atualizarNomesEscola() {
            const nome = 'BIBLIOTECA ESCOLAR DA EMTI PROFESSORA MARIA V√ÇNIA FARIAS LINHARES';
            const el = document.getElementById('nomeEscolaAdmin');
            if (el) el.innerText = nome;
        }

        async function init() {
            while(!window.DB) await new Promise(r => setTimeout(r, 100));
            await window.DB.checkAuth();
            
            atualizarNomesEscola();

            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('darkModeBtn').innerText = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            document.documentElement.style.setProperty('--font-size', fontSize + 'px');

            const cats = window.DB.CATEGORIAS;
            const options = '<option value="">SELECIONE</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('categoria').innerHTML = options;
            document.getElementById('editCategoria').innerHTML = options;

            const catTabs = ['TODOS', ...cats].map(c => 
                `<button class="tab-btn ${currentCat === c ? 'active' : ''}" onclick="setCat('${c}')">${c}</button>`
            ).join('');
            document.getElementById('admin-cats').innerHTML = catTabs;

            window.DB.onLivrosChange(() => load());
            window.DB.onEmprestimosChange(() => load());
            load();
        }

        window.switchTab = (e, id) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            e.currentTarget.classList.add('active');
        };

        window.setCat = (c) => {
            currentCat = c;
            document.querySelectorAll('#admin-cats .tab-btn').forEach(b => b.classList.toggle('active', b.innerText === c));
            load();
        };

        async function load() {
            todosLivros = await window.DB.getLivros();
            const emps = await window.DB.getEmprestimosAtivos();
            const termo = document.getElementById('buscaAdmin').value.toUpperCase();
            const idsAtrasados = [...new Set(emps.filter(e => e.atrasado).map(e => e.livro_id))];

            let filtrados = todosLivros;
            if (currentCat !== 'TODOS') filtrados = filtrados.filter(l => l.categoria === currentCat);
            if (termo) filtrados = filtrados.filter(l =>
                l.id.toString().includes(termo) ||
                l.titulo.includes(termo) ||
                (l.isbn && l.isbn.toUpperCase().includes(termo)) ||
                (l.autor && l.autor.toUpperCase().includes(termo)) ||
                (l.sinopse && l.sinopse.toUpperCase().includes(termo))
            );

            // Ordenar por ID decrescente (√öltimo cadastrado no topo)
            filtrados.sort((a, b) => b.id - a.id);

            // Atrasados apenas da categoria selecionada
            const atrasados = filtrados.filter(l => idsAtrasados.includes(l.id));
            const secao = document.getElementById('secaoAtrasadosAdmin');
            if (atrasados.length > 0) {
                secao.classList.remove('hidden');
                document.getElementById('listaAtrasadosAdmin').innerHTML = atrasados.map(l => renderLivro(l, true)).join('');
            } else secao.classList.add('hidden');

            document.getElementById('listaAdmin').innerHTML = filtrados.map(l => renderLivro(l, false)).join('');
        }

        function renderLivro(l, isAtr) {
            const prefix = isAtr ? 'adm-atr-' : 'adm-';
            const borderStyle = isAtr ? 'style="border-color:var(--danger); border-width: 2px;"' : '';
            return `
                <div class="book-item" ${borderStyle}>
                    <div class="book-header" onclick="toggleAcc(this, '${prefix}')">
                        <div class="accordion-indicator">‚ñº</div>
                        <div class="book-title">${isAtr ? '‚ö†Ô∏è ' : ''}ID ${l.id}: ${l.titulo}</div>
                        <div class="book-meta-box">
                            <div class="book-meta-item"><strong>AUTOR:</strong> ${l.autor || 'N√ÉO INFORMADO'}</div>
                            <div class="book-meta-item"><strong>ISBN:</strong> ${l.isbn || 'N/A'}</div>
                            <div class="book-meta-item"><strong>CATEGORIA:</strong> ${l.categoria}</div>
                            ${l.sinopse ? \`<div class="book-meta-item" style="margin-top:0.5rem; color:var(--text); font-size:0.75rem; background:var(--bg); padding:0.5rem; border-radius:6px;"><strong>SINOPSE:</strong> \${l.sinopse}</div>\` : ''}
                        </div>
                        <div class="book-status-row">
                            <div style="display:flex; gap:0.5rem;">
                                <button class="control-btn" onclick="event.stopPropagation(); openEdit(\${l.id})" style="background:var(--primary); width:40px; height:40px; border-radius:8px; font-size:1.2rem;">‚úèÔ∏è</button>
                                <button class="control-btn" onclick="event.stopPropagation(); delLivro(\${l.id})" style="background:var(--danger); width:40px; height:40px; border-radius:8px; font-size:1.2rem;">üóëÔ∏è</button>
                            </div>
                            <span class="badge \${l.quantidade_disponivel > 0 ? 'badge-disponivel' : 'badge-indisponivel'}">
                                \${l.quantidade_disponivel}/\${l.quantidade_total} DISPON√çVEIS
                            </span>
                        </div>
                    </div>
                    <div class="book-details" id="\${prefix}det-\${l.id}" data-id="\${l.id}">
                        <div id="\${prefix}emps-\${l.id}"></div>
                    </div>
                </div>
            `;
        }

        window.toggleAcc = (el, prefix) => {
            const content = el.nextElementSibling;
            const indicator = el.querySelector('.accordion-indicator');
            content.classList.toggle('active');
            el.classList.toggle('active');
            if (indicator) indicator.classList.toggle('active');
            if (content.classList.contains('active')) loadEmps(content.dataset.id, prefix);
        };

        function obterRotuloGenero(sexo, turmaAluno, anoAluno) {
            if (turmaAluno === 'PROF/FUNC' || turmaAluno === 'PROFESSOR' || turmaAluno === 'FUNCIONARIO') {
                return sexo === 'M' ? 'Funcion√°rio' : 'Funcion√°ria';
            } else {
                const genero = sexo === 'M' ? 'Aluno' : 'Aluna';
                return \`\${genero}, \${anoAluno}¬∫ ano, \${turmaAluno}\`;
            }
        }
        
        async function loadEmps(id, prefix) {
            const container = document.getElementById(\`\${prefix}emps-\${id}\`);
            const emps = await window.DB.getEmprestimosAtivos(parseInt(id));
            if (emps.length === 0) { container.innerHTML = '<p style="font-size:0.7rem;">SEM EMPR√âSTIMOS.</p>'; return; }
            container.innerHTML = emps.map(e => {
                const rotulo = obterRotuloGenero(e.sexo, e.turma_aluno, e.ano_aluno);
                return `
                <div class="loan-item" style="background:var(--card); padding:0.75rem; border-radius:8px; margin-bottom:0.5rem; font-size:0.75rem; border:1px solid var(--border);">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <strong>${e.nome_aluno}</strong> (${rotulo})<br>
                            DEVOLU√á√ÉO: ${e.sem_data_definida ? 'SEM DATA' : new Date(e.data_prevista_devolucao).toLocaleDateString('pt-BR')}
                            ${e.atrasado ? '<span class="atrasado-label" style="display:inline; margin-left:5px;">‚ö†Ô∏è ATRASADO</span>' : ''}
                        </div>
                        <button class="btn-small btn-success" onclick="devolver(${e.id})">DEVOLVER</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        window.devolver = async (id) => {
            if(confirm('CONFIRMAR DEVOLU√á√ÉO?')) {
                await window.DB.devolverLivro(id);
                load();
            }
        };

        window.delLivro = async (id) => {
            if(confirm('EXCLUIR LIVRO E TODOS OS REGISTROS?')) {
                await window.DB.excluirLivro(id);
                load();
            }
        };

        window.openEdit = (id) => {
            const l = todosLivros.find(x => x.id === id);
            document.getElementById('editId').value = l.id;
            document.getElementById('editIsbn').value = l.isbn || '';
            document.getElementById('editTitulo').value = l.titulo;
            document.getElementById('editAutor').value = l.autor || '';
            document.getElementById('editCategoria').value = l.categoria;
            document.getElementById('editQtd').value = l.quantidade_total;
            document.getElementById('editSinopse').value = l.sinopse || '';
            document.getElementById('modalEdit').classList.remove('hidden');
        };

        window.closeModal = () => document.getElementById('modalEdit').classList.add('hidden');

        document.getElementById('formEdit').addEventListener('submit', async (e) => {
            e.preventDefault();
            await window.DB.atualizarLivro({
                id: parseInt(document.getElementById('editId').value),
                isbn: document.getElementById('editIsbn').value,
                titulo: document.getElementById('editTitulo').value,
                autor: document.getElementById('editAutor').value,
                categoria: document.getElementById('editCategoria').value,
                quantidade_total: parseInt(document.getElementById('editQtd').value),
                sinopse: document.getElementById('editSinopse').value
            });
            closeModal();
            load();
        });

        document.getElementById('formLivro').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await window.DB.salvarLivro({
                    isbn: document.getElementById('isbn').value,
                    titulo: document.getElementById('titulo').value,
                    autor: document.getElementById('autor').value,
                    categoria: document.getElementById('categoria').value,
                    quantidade_total: parseInt(document.getElementById('quantidade').value),
                    sinopse: document.getElementById('sinopse').value
                });
                document.getElementById('msgLivro').innerHTML = '<span style="color:var(--success)">‚úì CADASTRADO!</span>';
                e.target.reset();
                load();
            } catch(err) { document.getElementById('msgLivro').innerHTML = '<span style="color:var(--danger)">‚ùå ERRO</span>'; }
        });

        window.toggleTipoPessoa = () => {
            const cb = document.getElementById('ehProfessor');
            const isP = cb.checked;
            document.getElementById('camposAluno').style.display = isP ? 'none' : 'contents';
            document.getElementById('camposProfessor').style.display = isP ? 'block' : 'none';
        };

        window.toggleData = () => {
            const cb = document.getElementById('semData');
            document.getElementById('dias').disabled = cb.checked;
        };

        document.getElementById('livroSearch').addEventListener('input', async (e) => {
            const t = e.target.value.toUpperCase();
            const sug = document.getElementById('sugestoes');
            if(!t) { sug.style.display = 'none'; return; }
            const res = todosLivros.filter(l => l.titulo.toUpperCase().includes(t) || l.id.toString().includes(t)).slice(0,5);
            sug.innerHTML = res.map(l => `<div onclick="selLivro(\${l.id},'\${l.titulo}')" style="padding:0.8rem; border-bottom:1px solid var(--border); cursor:pointer;">ID \${l.id}: \${l.titulo}</div>`).join('');
            sug.style.display = 'block';
        });

        window.selLivro = (id, t) => {
            document.getElementById('livroId').value = id;
            document.getElementById('livroSearch').value = t;
            document.getElementById('sugestoes').style.display = 'none';
        };

        document.getElementById('formEmprestimo').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const isP = document.getElementById('ehProfessor').checked;
                const data = {
                    livro_id: parseInt(document.getElementById('livroId').value),
                    sem_data_definida: document.getElementById('semData').checked,
                    dias_emprestimo: document.getElementById('dias').value
                };
                if(isP) { 
                    data.nome_aluno = document.getElementById('nomeProfessor').value; 
                    data.turma_aluno = 'PROF/FUNC'; 
                    data.sexo = document.getElementById('sexoProfessor').value; 
                    data.ano_aluno = 0; 
                }
                else { 
                    data.nome_aluno = document.getElementById('nomeAluno').value; 
                    data.sexo = document.getElementById('sexo').value; 
                    data.ano_aluno = document.getElementById('ano').value; 
                    data.turma_aluno = document.getElementById('turma').value; 
                }
                await window.DB.registrarEmprestimo(data);
                document.getElementById('msgEmp').innerHTML = '<span style="color:var(--success)">‚úì REGISTRADO!</span>';
                e.target.reset();
                toggleTipoPessoa();
                toggleData();
                load();
            } catch(err) { document.getElementById('msgEmp').innerHTML = `<span style="color:var(--danger)">‚ùå \${err.message}</span>`; }
        });

        document.getElementById('buscaAdmin').addEventListener('input', load);
        init();
    </script>
</body>
</html>
